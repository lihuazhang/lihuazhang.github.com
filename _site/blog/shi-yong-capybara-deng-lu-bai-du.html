
<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
   <meta charset="utf-8" />
   <!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
   <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

   <title>使用 capybara 登陆百度 - 8:00 PM at My House</title>
	
	<meta name="description" content="

  
    
       2013-02-12
        Capybara 
      
       comments
    
  
  ShiLongLu 问你有什么办法测试百度的登录窗口呢？这是差不多2个月前的问题了，我一直忙于 Dota 圣剑传说。恰巧春节有时间看了下...">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<link href="" rel="alternate" title="8:00 PM at My House" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
   <meta name="robots" content="noindex, nofollow">
   <meta name="keywords" content="metro, metroui, metro-ui, metro ui, windows 8, metro style, bootstrap, framework, web framework, css, html" />
   <meta name="author" content="晋恒温"/>

   <!-- remove or comment this line if you want to use the local fonts -->
   <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700' rel='stylesheet' type='text/css'>

   <link rel="stylesheet" type="text/css" href="/bootmetro/css/bootstrap.css">
   <link rel="stylesheet" type="text/css" href="/bootmetro/css/bootstrap-responsive.css">
   <link rel="stylesheet" type="text/css" href="/bootmetro/css/bootmetro.css">
   <link rel="stylesheet" type="text/css" href="/bootmetro/css/bootmetro-tiles.css">
   <link rel="stylesheet" type="text/css" href="/bootmetro/css/metro-ui-light.css">
   <link rel="stylesheet" type="text/css" href="/bootmetro/css/icomoon.css">
   <link rel="stylesheet" type="text/css" href="/stylesheets/syntax.css">
   <link rel="stylesheet" type="text/css" href="/stylesheets/custom.css">

   <!-- All JavaScript at the bottom, except for Modernizr and Respond.
      Modernizr enables HTML5 elements & feature detects; Respond is a polyfill for min/max-width CSS3 Media Queries
      For optimal performance, use a custom Modernizr build: www.modernizr.com/download/ -->
   <script src="/scripts/modernizr-2.6.1.min.js"></script>
</head>
<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you support IE 6.
     chromium.org/developers/how-tos/chrome-frame-getting-started -->
<!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->


<body>
<header id="nav-bar" class="container-fluid">
   <div class="row-fluid">
      <div class="span8">
         <div id="header-container">
            <a id="backbutton" class="win-backbutton" href ="javascript:history.go(-1);"></a>
            <h5>8:00 PM at My House</h5>
            <div class="dropdown">
               <a class="header-dropdown dropdown-toggle accent-color" data-toggle="dropdown" href="#">
                 使用 capybara 登陆百度
                  <b class="caret"></b>
               </a>
               <ul class="dropdown-menu">
               	<li><a href="/archives.html">存档</a></li>
               	<li><a href="/categories.html">分类</a></li>
               <li class="divider"></li>
               <li><a href="/index.html">Home</a></li>
            </ul>
         </div>
         </div>
      </div>
      <div id="top-info" class="pull-right">
      <a href="/about_me.html" class="pull-left">
         <div id="authorname" class="top-info-block">
           <h3>晋恒温</h3>
         </div>
         <div class="top-info-block">
            <b class="icon-user"></b>
         </div>
      </a>
   </div>
</div>
</header>


<div class="container">
<article class="entry" id="/blog/shi-yong-capybara-deng-lu-bai-du">
  <header>
    <p class="entry-meta">
      <i aria-hidden="true" class="icon-pen-alt-fill"></i> <time>2013-02-12</time>
      <i aria-hidden="true" class="icon-folder"></i> <a href="/categories.html#Capybara-ref"> Capybara </a>
      
      <i aria-hidden="true" class="icon-comments-3"></i> <a href="#comment">comments</a>
    </p>
  </header>
  <p>ShiLongLu 问你有什么办法测试百度的登录窗口呢？这是差不多2个月前的问题了，我一直忙于 Dota 圣剑传说。恰巧春节有时间看了下。</p>

<p>百度登陆的时候是弹出一个对话框，如图：</p>

<p><img src="/photos/baidulogin.png" alt=""></p>

<p>但是这个对话框是用 iframe 实现的。</p>
<div class="highlight"><pre><code class="html"><span class="nt">&lt;iframe</span> <span class="na">height=</span><span class="s">&quot;100%&quot;</span> <span class="na">frameborder=</span><span class="s">&quot;0&quot;</span> <span class="na">width=</span><span class="s">&quot;100%&quot;</span> <span class="na">scrolling=</span><span class="s">&quot;no&quot;</span> <span class="na">src=</span><span class="s">&quot;http://www.baidu.com/cache/user/html/login-1.2.html&quot;</span> <span class="na">marginheight=</span><span class="s">&quot;0&quot;</span> <span class="na">marginwidth=</span><span class="s">&quot;0&quot;</span> <span class="na">id=</span><span class="s">&quot;login_iframe&quot;</span><span class="nt">&gt;</span>
...
...
...
<span class="nt">&lt;/iframe&gt;</span>
</code></pre></div>
<p>所以在填写用户名和密码的时候，需要先 switch 到这个 frame 上去， </p>

<blockquote>
<p>When working inside a frame, you should use Capybara&#39;s within_frame method.</p>

<ul>
<li>(Object) within<em>frame(frame</em>id)</li>
</ul>

<p>Execute the given block within the given iframe given the id of that iframe. Only works on some drivers (e.g. Selenium)</p>

<p>Parameters:
frame_id (String) — Id of the frame</p>
</blockquote>

<p>所以我们的实现基本如下：</p>

<p>baidu.feature:</p>
<div class="highlight"><pre><code class="ruby"><span class="no">Given</span> <span class="n">I</span> <span class="n">am</span> <span class="n">on</span> <span class="n">baidu</span><span class="o">.</span><span class="n">com</span>
<span class="no">When</span> <span class="n">I</span>  <span class="n">click</span> <span class="s2">&quot;登录&quot;</span>
<span class="no">And</span> <span class="n">I</span> <span class="n">switch</span> <span class="n">to</span> <span class="n">login</span> <span class="n">form</span>
<span class="no">And</span> <span class="n">I</span> <span class="n">enter</span> <span class="s2">&quot;lihuazhang@hotmail.com&quot;</span> <span class="k">for</span> <span class="s2">&quot;帐号&quot;</span>
<span class="no">And</span> <span class="n">I</span> <span class="n">enter</span> <span class="s2">&quot;204646&quot;</span> <span class="k">for</span> <span class="s2">&quot;密码&quot;</span>
<span class="no">And</span> <span class="n">I</span> <span class="n">click</span> <span class="s2">&quot;登录&quot;</span> <span class="n">button</span>
<span class="no">Then</span> <span class="n">I</span> <span class="n">should</span> <span class="n">see</span> <span class="s2">&quot;zhangzuichi&quot;</span>
</code></pre></div>
<p>step_definition.rb:</p>
<div class="highlight"><pre><code class="ruby"><span class="no">When</span> <span class="sr">/^I enter &quot;(.*?)&quot; for &quot;(.*?)&quot;$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">value</span><span class="p">,</span> <span class="n">key</span><span class="o">|</span>
  <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;帐号&quot;</span>
    <span class="n">within_frame</span> <span class="s1">&#39;login_iframe&#39;</span> <span class="k">do</span>
      <span class="n">fill_in</span> <span class="s1">&#39;pass_login_username_0&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">value</span>
    <span class="k">end</span>
  <span class="k">else</span>
     <span class="n">within_frame</span> <span class="s1">&#39;login_iframe&#39;</span> <span class="k">do</span>
      <span class="n">fill_in</span> <span class="s1">&#39;pass_login_password_0&#39;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">value</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">When</span> <span class="sr">/^I click &quot;(.*?)&quot; button$/</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg1</span><span class="o">|</span>
  <span class="n">within_frame</span> <span class="s1">&#39;login_iframe&#39;</span> <span class="k">do</span>
    <span class="n">click_button</span> <span class="s1">&#39;pass_login_input_submit_0&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div>
<p>大致如此，在 firefox 下测试通过。</p>

</article>


<section id="comment">
  <!-- Duoshuo Comment BEGIN -->
<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"jinhengwen" };
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>
<!-- Duoshuo Comment END -->


</section>



</div>



<!-- Grab Google CDN's jQuery. fall back to local if necessary -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script>window.jQuery || document.write("<script src='/scripts/jquery-1.8.2.min.js'>\x3C/script>")</script>
<script type="text/javascript" src="/scripts/jquery.mousewheel.js"></script>
<script type="text/javascript" src="/scripts/jquery.scrollTo.js"></script>
<script type="text/javascript" src="/scripts/bootstrap.min.js"></script>
<script type="text/javascript" src="/scripts/bootstrap-carousel.js"></script>
<script type="text/javascript" src="/scripts/bootmetro.js"></script>
<script type="text/javascript" src="/scripts/holder.js"></script>
<script type="text/javascript" src="/scripts/tile-slider.js"></script>
<script type="text/javascript">
   $(".metro").metro();
</script>

</body>
</html>
